<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh S√°ch Ph√°t - THONO MUSIC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    <script src="audio_player.js" defer></script>
    <style>
        .playlist-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 100vh;
            background-size: cover;
            background-position: center;
            filter: blur(50px);
            opacity: 0.2;
            transition: background-image 0.7s ease;
            z-index: -2;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.5rem;
        }

        .song-item {
            transition: all 0.3s ease;
            border-radius: 0.75rem;
        }
        .song-item:hover {
            transform: scale(1.02);
            background: rgba(255, 255, 255, 0.08);
        }
        .playing {
            background: rgba(99, 102, 241, 0.15);
            border-left: 4px solid #6366f1;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.6s ease forwards;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white min-h-screen">
    <div class="playlist-backdrop"></div>
    
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="w-80 p-6 glass-card m-4 rounded-2xl animate-slide-in" style="animation-delay: 0.1s;">
            <a href="home.html" class="text-white/70 hover:text-white flex items-center gap-2 mb-8 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                Quay l·∫°i
            </a>

            <div class="text-center space-y-6">
                <img id="playlistCover" alt="·∫¢nh playlist" 
                     class="w-56 h-56 mx-auto rounded-2xl shadow-2xl transform transition hover:scale-105">
                <h1 id="playlistTitle" class="text-3xl font-bold"></h1>
                <p id="songCount" class="text-gray-400"></p>
                
                <div class="space-y-3">
                    <button onclick="playSong(0)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl flex items-center justify-center gap-2 transition-colors">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        Ph√°t t·∫•t c·∫£
                    </button>
                    <button class="w-full bg-white/5 hover:bg-white/10 text-white px-8 py-3 rounded-xl transition-colors">
                        Ph√°t ng·∫´u nhi√™n
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6">
            <div class="glass-card p-6 animate-slide-in" style="animation-delay: 0.2s;">
                <h2 class="text-2xl font-bold mb-6">Danh s√°ch b√†i h√°t</h2>
                <ul id="songsList" class="space-y-2">
                    <!-- Songs will be loaded here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Audio Player -->
    <div id="audioPlayerContainer"></div>

    <script>
        const API_URL = "http://localhost:3000";
        let songs = [];
        let audioPlayer;
        let currentIndex = 0;

        document.addEventListener("DOMContentLoaded", async () => {
            // Initialize audioPlayer when the page loads
            audioPlayer = new AudioPlayer(API_URL);
            // audioPlayer.onEnd(() => handleNextTrack());
            
            // Add keyboard controls
            document.addEventListener('keydown', (e) => {
                if (e.code === 'ArrowRight') handleNextTrack();
                if (e.code === 'ArrowLeft') handlePrevTrack();
            });
            
            const urlParams = new URLSearchParams(window.location.search);
            const playlistId = urlParams.get("id");
            
            if (playlistId) {
                await loadUserPlaylist(playlistId);
            } else {
                loadRandomPlaylist();
            }
            await fetchSongDetails();
            displaySongs();
        });
    

        async function loadUserPlaylist(playlistId) {
    try {
        const token = localStorage.getItem("token");
        if (!token) {
            alert("‚ö†Ô∏è B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
            window.location.href = "login.html";
            return;
        }

        const response = await fetch(`${API_URL}/playlist/${playlistId}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (!response.ok) {
            throw new Error("Kh√¥ng th·ªÉ t·∫£i playlist!");
        }

        const playlistData = await response.json();
        console.log("üì• D·ªØ li·ªáu nh·∫≠n t·ª´ API:", playlistData); // ‚úÖ Ki·ªÉm tra API c√≥ tr·∫£ v·ªÅ danh s√°ch nh·∫°c kh√¥ng

        if (!playlistData.songs || playlistData.songs.length === 0) {
            console.warn("‚ö†Ô∏è API kh√¥ng tr·∫£ v·ªÅ b√†i h√°t n√†o!");
            return;
        }

        songs = [...playlistData.songs]; // ‚úÖ L∆∞u danh s√°ch b√†i h√°t v√†o m·∫£ng

        if (audioPlayer && typeof audioPlayer.setPlaylist === "function") {
            audioPlayer.setPlaylist(songs);
            console.log("‚úÖ Danh s√°ch b√†i h√°t ƒë√£ ƒë∆∞·ª£c g√°n v√†o audioPlayer:", songs);
        } else {
            console.error("‚ùå L·ªói: AudioPlayer ch∆∞a kh·ªüi t·∫°o ho·∫∑c setPlaylist kh√¥ng t·ªìn t·∫°i!");
        }

    } catch (error) {
        console.error("‚ùå L·ªói khi t·∫£i playlist:", error);
    }
}




    
        async function fetchSongDetails() {
            try {
                if (songs.length === 0) return;

                // Chuy·ªÉn danh s√°ch b√†i h√°t th√†nh query string
                const songTitles = songs.map(song => encodeURIComponent(song.title)).join(",");
                const response = await fetch(`${API_URL}/songs?titles=${songTitles}`);

                if (!response.ok) {
                    throw new Error("Kh√¥ng th·ªÉ l·∫•y th√¥ng tin b√†i h√°t!");
                }

                const songData = await response.json();

                // C·∫≠p nh·∫≠t danh s√°ch b√†i h√°t v·ªõi th√¥ng tin ngh·ªá sƒ©
                songs = songs.map(song => {
                    const matchedSong = songData.find(s => s.title === song.title);
                    return matchedSong ? { ...song, artist: matchedSong.artist } : song;
                });

            } catch (error) {
                console.error("L·ªói khi l·∫•y th√¥ng tin b√†i h√°t:", error);
            }
        }

        function loadRandomPlaylist() {
    const playlistData = JSON.parse(sessionStorage.getItem("currentPlaylist"));
    
    if (!playlistData || !playlistData.songs || playlistData.songs.length === 0) {
        alert("Kh√¥ng t√¨m th·∫•y playlist ho·∫∑c playlist r·ªóng!");
        return;
    }

    document.getElementById("playlistTitle").textContent = playlistData.name;
    document.getElementById("songCount").textContent = `${playlistData.songs.length} b√†i h√°t`;

    songs = [...playlistData.songs]; // ‚úÖ Sao ch√©p d·ªØ li·ªáu v√†o m·∫£ng m·ªõi
    console.log("üîÑ Playlist t·ª´ sessionStorage:", songs);

    if (audioPlayer && typeof audioPlayer.setPlaylist === "function") {
        audioPlayer.setarray(songs); // ‚úÖ G·ªçi setPlaylist()
        console.log("‚úÖ ƒê√£ g·ªçi setarray() t·ª´ loadRandomPlaylist()");
    } else {
        console.error("‚ùå L·ªói: AudioPlayer ch∆∞a kh·ªüi t·∫°o ho·∫∑c setPlaylist kh√¥ng t·ªìn t·∫°i!");
    }
}


        function displaySongs() {
            const songList = document.getElementById("songsList");
            songList.innerHTML = "";

            songs.forEach((song, index) => {
                const li = document.createElement("li");
                li.className = "song-item p-4 flex items-center justify-between group hover:bg-white/5 transition-all";
                li.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-white/40 group-hover:text-indigo-400 w-6 text-sm">${index + 1}</span>
                        <div class="flex flex-col">
                            <span class="font-medium">${song.title}</span>
                            <span class="text-sm text-white/60">${song.artist || "Kh√¥ng x√°c ƒë·ªãnh"}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-white/40">03:45</span>
                        <button onclick="playSongByFilename('${song.filename}', ${index})" 
                            class="opacity-0 group-hover:opacity-100 transition-opacity">
                            <svg class="w-8 h-8 text-white/60 hover:text-indigo-400 transition-colors" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </button>
                    </div>
                `;
                songList.appendChild(li);
            });
        }

        async function playSongByFilename(filename, index) {
            try {
                currentIndex = index || 0;
                if (!audioPlayer) {
                    audioPlayer = new AudioPlayer(API_URL);
                }

                const response = await fetch(`${API_URL}/song-by-filename/${encodeURIComponent(filename)}`);
                const song = await response.json();

                if (!response.ok || !song.url) {
                    throw new Error("Kh√¥ng t√¨m th·∫•y b√†i h√°t!");
                }

                const songUrl = `${API_URL}/play/${encodeURIComponent(song.artist)}/${encodeURIComponent(song.filename)}`;
                await audioPlayer.loadTrack(songUrl, song.title || filename, song.artist || "Ch∆∞a x√°c ƒë·ªãnh");
                
                // Add next/prev handlers
                audioPlayer.nextTrack();
                audioPlayer.prevTrack();
                
                // Update playing state in UI
                document.querySelectorAll('.song-item').forEach(item => item.classList.remove('playing'));
                const currentSong = document.querySelector(`[onclick*="${filename}"]`).closest('.song-item');
                currentSong.classList.add('playing');
            } catch (error) {
                console.error("‚ùå L·ªói khi ph√°t nh·∫°c:", error);
                alert("Kh√¥ng th·ªÉ ph√°t b√†i h√°t n√†y. Vui l√≤ng th·ª≠ l·∫°i sau!");
            }
        }
        function handleNextTrack() {
    if (audioPlayer && typeof audioPlayer.nextTrack === "function") {
        audioPlayer.nextTrack();
    } else {
        console.error("‚ùå L·ªói: nextTrack() kh√¥ng t·ªìn t·∫°i tr√™n audioPlayer!");
    }
}

function handlePrevTrack() {
    if (audioPlayer && typeof audioPlayer.prevTrack === "function") {
        audioPlayer.prevTrack();
    } else {
        console.error("‚ùå L·ªói: prevTrack() kh√¥ng t·ªìn t·∫°i tr√™n audioPlayer!");
    }
}

    </script>
</body>
</html>
